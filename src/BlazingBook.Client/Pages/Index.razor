@page "/"
@inject HttpClient HttpClient
@inject OrderState OrderState
@implements IDisposable
@inject IJSRuntime IJSRuntime
@inject NavigationManager NavigationManager
@inject IJSRuntime JS
@inject Blazored.Localisation.Services.IBrowserDateTimeProvider browserDateTimeProvider

@if (Order.Books.Any()) {
<Sidebar @ref="sidebar">
    <SidebarContent>
        <SidebarNavigation>
                <SidebarLabel>Shopping Bag <NavBasket /></SidebarLabel>
                    <SidebarItem>
                        @foreach (var configuredBook in Order.Books) {
                            <ConfiguredBookItem BookCustom="configuredBook" OnRemoved="@(() => RemoveBook(configuredBook))" />
                        }
                    </SidebarItem>
                    <SidebarItem>
                        <div class="order-total @(Order.Books.Any() ? "" : "hidden")">
                            Total:
                    
                            <span class="total-price">@Order.GetFormattedTotalPrice()</span>
                            <a href="checkout">
                                <Button Color="Color.Warning" disabled="@(Order.Books.Count == 0)">
                                Order
                                </Button>
                            </a>
                        </div>
                    </SidebarItem>
        </SidebarNavigation>
    </SidebarContent>
</Sidebar>
}

<div class="main">
    <Column ColumnSize="ColumnSize.Is4" Class="text-center">
        <TextEdit Placeholder="Search..." @bind-Text="@search"/>
    </Column>
    @if (Bookbases != null) {
        <CardGroup>
            @foreach (var item in Bookbases){
            <Column ColumnSize="ColumnSize.Is4.OnTablet.Is3.OnWidescreen.Is12.OnMobile">
                <Card Margin="Margin.Is4.OnY">
                        <CardImage src="@item.ImageUrl">
                        </CardImage>
                        <CardBody>
                            <CardTitle>@item.Name</CardTitle>
                            <CardSubtitle>@item.Description</CardSubtitle>
                            <CardText class="price">@CultureInfo.CurrentUICulture.NumberFormat.CurrencySymbol @item.GetFormattedBasePrice()</CardText>
                            <Button @onclick="@(() => OrderState.ShowConfigureBookDialog(item))">
                                <span class="iconify" data-icon="ant-design:shopping-cart-outlined" data-inline="true"></span>
                            </Button>
                            <Button @onclick="@(() => OrderState.AddToWishList(item))">
                                <span class="iconify" data-icon="ant-design:heart@(OrderState.WishList.Any(wishlist => wishlist.BookId == item.Id) ? "-filled" : "")" data-inline="false"></span>
                            </Button>
                        </CardBody>
                </Card>
            </Column>
            }
        </CardGroup>
    }
</div>


<TemplatedDialog Show="OrderState.ShowingConfigureDialog">
    <ConfigureBookDialog
        BookCustom="OrderState.ConfiguringBook"
        OnCancel="OrderState.CancelConfigureBookDialog"
        OnConfirm="OrderState.ConfirmConfigureBookDialog" />
</TemplatedDialog>

@code {
    Sidebar sidebar;
    void ToggleSidebar(){
        sidebar.Toggle();
    }
    string search;
    List<BookBase> Bookbases;
    Order Order => OrderState.Order;

    protected async override Task OnInitializedAsync() {
        Bookbases = await HttpClient.GetJsonAsync<List<BookBase>>("bookbase");
        await OrderState.GetWishes();
    }

    protected override void OnParametersSet() {
        OrderState.OnChange += StateHasChanged;
    }
    public void Dispose() {
        OrderState.OnChange -= StateHasChanged;
    }

    async Task RemoveBook(BookCustom configuredBook) {
        if (await JS.Confirm($"Remove {configuredBook.BookBase.Name} book from the order?")) {
            OrderState.RemoveConfiguredBook(configuredBook);
        }
    }
}